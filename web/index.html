<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Planificador de Docencia 2014-15</title>

    <!-- jQuery + JQuery UI (for tooltips) -->
    <script type="text/javascript" src="js/lib/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
    <link rel="stylesheet" href="js/lib/ui-lightness/jquery-ui-1.10.3.custom.min.css" type="text/css"/>

    <script type="text/javascript" src="js/plan.js"></script>
    <script type="text/javascript" src="data/latest.js"></script>

    <link rel="stylesheet" href="js/plan.css" type="text/css"/>

<script type="text/javascript">
$(function() {

    var menu = new pa.Menu();
    menu.load(data);
    $("#last_version").text(metadata);

    var plan = new pa.Plan(menu);
    var tt1 = new pa.TimeTable('tt1', '#hc1', "1", plan);
    var tt2 = new pa.TimeTable('tt2', '#hc2', "2", plan);
    var tl = new pa.List('tl', '#list', menu);

    // inicialmente, todo es compatible
    $("#tl tbody>tr").each(function() {
        $(this).addClass("compatible");
    });

    function cambiaDisponibilidad(tr, topic, soloAInaccesible, mismoUsuario) {
        if (mismoUsuario === true) {
            if (! tr.hasClass("selected")) {
                seleccionaAsignatura(topic);
            } else {
                // ya seleccionada;
            }
            return;
        }

        if (tr.hasClass("unavailable") && soloAInaccesible) {
            return;
        }
        tr.toggleClass("unavailable");
        if (tr.hasClass("unavailable")) {
            tr.find("span.x").text("no disponible");
        } else {
            tr.find("span.x").text("disponible");
        }
        actualizaCompatibles();
    }

    function actualizaCompatibles() {
        $("#tl tbody>tr").each(function() {
            $(this).removeClass("compatible");
            if ( ! $(this).hasClass("unavailable") && ! $(this).hasClass("selected")) {
                if (plan.compatible($(this).data("topic"))) {
                    $(this).addClass("compatible");
                }
            }
        });
    }

    function seleccionaAsignatura(topic) {
        if (topic !== undefined) {
            var tr = $("tr#tl"+topic.id);
            if (! tr.hasClass("selected") &&
                (tr.hasClass("unavailable") || ! tr.hasClass("compatible"))) {
                // no permite seleccionar incompatibles
                return false;
            }
            tr.toggleClass("selected");
        }
        plan.reset();
        tt1.clear();
        tt2.clear();
        $("#tl tr.selected").each(function() {
            var t = $(this).data("topic");
            tt1.add(t);
            tt2.add(t);
            plan.add(t);
        });
        pa.fixTotal(".totales", plan);
        actualizaCompatibles();
        return false;
    }

    // comportamiento "click en disponibilidad"
    $("#tl").on("click", "td span.x", function() {
        var tr = $(this).closest("tr");
        var topic = tr.data("topic");
        cambiaDisponibilidad(tr, topic);
        return false;
    });

    // comportamiento "click en asignatura"
    $("#tl").on("click", "tr", function() {
        var tr = $(this);
        var topic = tr.data("topic");
        seleccionaAsignatura(topic);
        return false;
    });

    // boton de "cambia filtro"
    $("#f_tipo").change(function() {
        console.debug("tipo es:", $("#f_tipo").val());
        $("#tl tr.topic").show();
        var v = $("#f_tipo").val();
        if (v == "f_libres") {
            $("#tl tr.unavailable").hide();
        } else if (v == "f_mias") {
            $("#tl tr.topic").hide();
            $("#tl tr.selected").show();
        }
    });

    // boton de "salvar"
    $("#salvar").click(function() {
        console.log("salvando...");
        var login = $("#l_login").val();
        var pass = $("#l_pass").val();
        var sel = [];
        var bad = [];
        for (var i in plan.chosen) {
            sel.push(plan.chosen[i].id);
        }
        $("tr.unavailable").each(function(i, o) {
            bad.push($(o).data("topic").id);
        });
        var post = {"login": login, "pass": pass, "sel": sel, "bad": bad};
        console.debug(post);
        $.post("save.php", post, function(data) {
            $("#ultimo_guardado").text(("" + new Date()).split(" ")[4]);
            console.log(data);
        });

        // y refresca el listado
        $("#refresca_listado").click();        
    });

    // boton de "refresca_listado"
    $("#refresca_listado").click(function() {
        console.log("refrescando...");
        $.getJSON("list.php", function(data) {
            $("#carga_listado").find("option").remove();
            for (var i in data) {
            $("#carga_listado").append(
                "<option value='"+data[i][0]+"'>" +
                data[i][0] + " (" + data[i][1] + ")" +
                "</option>");
            }
        });
    });

    // boton de "confirma_carga"
    $("#confirma_carga").click(function() {
        console.log("cargando...");
        $.getJSON("load.php", {"login": $("#carga_listado").val()}, function(data) {
            console.log(data);
                       
            if (data.sel != null) {
                for (var i=0; i<data.sel.length; i++) {
                    var topic = menu.topics[data.sel[i]];
                    var tr = $("#tl tbody>tr#tl" + topic.id);
                    if ($("#carga_listado").val() === $("#l_login").val()) {
                        // permite reconfirmar reservas
                        if (topic.quien !== "") {
                            tr.removeClass("unavailable");
                            if (plan.compatible(topic)) {
                                tr.addClass("compatible");
                            }
                        }
                        cambiaDisponibilidad(tr, topic, false, true);
                    } else {
                        cambiaDisponibilidad(tr, topic, true);
                    }
                }
            }
            if (data.bad != null) {
                for (var i=0; i<data.bad.length; i++) {
                    var topic = menu.topics[data.bad[i]];
                    var tr = $("#tl tbody>tr#tl" + topic.id);
                    cambiaDisponibilidad(tr, topic, true);
                }
            }
        });
    });

    // boton de "ocultar_horarios"
    $("#ocultar_horarios").click(function() {
        $("#tt1,#tt2,.ttd").toggle();
        if ($("#tt1").is(':visible')) {
            seleccionaAsignatura();
        }
    });

    // boton de "cambiar de sitio"
    $("#mover_controles").click(function() {
        $("div#right,div#main").toggleClass("shifted");
    });
    
    $(document).tooltip({show: null, hide: null});

    $("#refresca_listado").click();

    $("#tl tbody>tr").each(function(i, o) {
        var tr = $(o);
        var topic = tr.data("topic");
        if ( ! tr.hasClass("unavailable") && topic.quien !== "") {
            cambiaDisponibilidad(tr, topic, true);
        }
    });
});

</script>
</head>
<body>
    <div id="right">
        <i>Datos refrescados: <span id="last_version"/> </i>
        <div id="filter">
            Filtrar para ver
            <select id="f_tipo" name="f_tipo">
                <option value="f_todas">todas las asignaturas</option>
                <option value="f_libres">las que quedan libres</option>
                <option value="f_mias">las que he seleccionado</option>
            </select>
            <ul>
                <li>Click en <i>disponible</i> ó <i>no disponible</i>: cambia disponibilidad.                
                <li>Click en resto de fila: añade / retira una asignatura de tu horario. (Solo si
                disponible y no tiene conflicto horario)
                <li>* = asignadas en ultimo excel (usa el cursor para ver quién).                
            </ul>
        </div>

        <button id="ocultar_horarios">ocultar/mostrar horarios</button> &nbsp;
        <button id="mover_controles">&lt;--&gt;</button><br>
        <div id="hc1"></div>
        <div id="hc2"></div>
        Total créditos: <span class='totales'></span>&nbsp;

        <hr/>

        <p>Salvar / cargar horarios</p>
        <div id="login">           
            <table>
            <tr><td><label for="login">usuario</label>
                <td><label for="pass">contraseña</label>
                <td>salvado a las <span id="ultimo_guardado">?</span>
            <tr><td><input type="text" name="login" id="l_login"
                    title="Para crear una cuenta, introduce un 'usuario' que no
                           exista en el sistema"/>
                <td><input type="password" name="pass" id="l_pass"
                    title="Para evitar machacar horarios ajenos. No uses una contraseña sensible"/>
                <td><button id="salvar"
                    title="Salva tu horario y lista de 'no-disponibles' actual, permitiendote
                    a tí y a otros cargarlo más adelante. Todos los horarios salvados son públicos">salvar</button>
            <tr><td><select id="carga_listado"></select>
                <td><button id="refresca_listado"
                    title="Refresca el listado de horarios subidos al servidor">&lt;-- refrescar</button>
                <td><button id="confirma_carga"
                    title="Carga el horario y lista de 'no-disponibles' seleccionado.
                    Si el usuario no coincide, marca entradas del horario como asignaturas 'no disponibles'.
                    Si el usuario coincide, restaura tanto las selecciones del horario como la lista de 'no disponibles'.">
                cargar</button>
            </table>
        </div>
    </div>

    <div id="main">
        <div id="list"></div>
        </div>
        <span class="creditos">
            Perpetrado por Manuel Freire,
            partiendo del excel de Luis.
            Si quieres comentarme algo,
            <a href="mailto:manuel.freire@fdi.ucm.es">escríbeme</a>. Licencia CC-A.
        </span>
    </div>

</body>
</html>
